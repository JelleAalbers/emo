{% extends "base.html" %}
{% load staticfiles %}
{% block content %}
<script src="{% static "jquery-ui-1.11.1/jquery-ui.js"%}"></script>
<link href="{% static "jquery-ui-1.11.1/jquery-ui.css" %}" rel="stylesheet">
<script src="{% static "DataTables-1.10.7/media/js/jquery.dataTables.min.js"%}"></script>
<link href="{% static "DataTables-1.10.7/media/css/jquery.dataTables.min.css"%}" rel="stylesheet" />
<script src="{% static "DataTables-1.10.7/extensions/TableTools/js/dataTables.tableTools.min.js"%}"></script>
<link href="{% static "DataTables-1.10.7/extensions/TableTools/css/dataTables.tableTools.min.css"%}" rel="stylesheet"/>

<script>
  $(function() {
     $( "#id_startdate" ).datepicker({
       changeMonth: true,
       changeYear: true
     });
  });
  $(function() {
     $( "#id_enddate" ).datepicker({
        changeMonth: true,
        changeYear: true
     });
  });
</script>

<style type="text/css">
    #id_startdate, #id_enddate, #id_mode, #id_custom{
        height: 20px;
        width: 70%;
        margin-top:10px;
    }
    td.runs-expand {
     background: url('{%static "img/details_open.png" %}') no-repeat center center;
     cursor: pointer;
    }
    tr.shown td.runs-expand {
       background: url('{%static "img/details_close.png" %}') no-repeat center center;
    }


</style>

<div class="col-xs-12 emo-search-bar" style="margin-bottom:15px;">
    <form method="GET" action="/runs/">
        <div class="row">
            <div class="col-xs-1" style="line-height:40px;"><strong>Filter:</strong></div>
            <div class="col-xs-2">From: {{form.startdate}} </div>
            <div class="col-xs-2">To:&nbsp;   {{form.enddate}} </div>
            <div class="col-xs-2">Mode: {{ form.mode }}</div>
            <div class="col-xs-3">Query: {{ form.custom }} </div>
            <div class="col-xs-2">
                <button class="btn btn-info btn-sm" style="margin:8px;" type="submit" name="submit" style="height:30%;">Filter</button>
            </div>
        </div>
    </form>
</div>

<div class="row" style="margin-bottom:8px;margin-left:5px;">
  <span><strong>Click rows to select runs. Then download selected as: </strong></span>&nbsp;
  <button class="btn btn-info" id='download_as_runlist'>Runs List</button>
  <button class="btn btn-info" id='download_as_raw'>Raw Paths</button>
  <button class="btn btn-info" id='download_as_processed'>Processed Paths</button>
</div>
    
<table class="display" id="runstable">
  <thead>
    <tr>
      <th>Detail</th>
      <th>Run name</th>
      <th>Date</th>
      <th>Mode</th>
      <th>Comments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="width:10px" class="runs-expand"></td>
      <td></td>
      <td></td>
      <td></td>
      <td style="pull-right"> 
	<span class="glyphicon glyphicon-comment">&nbsp</span>
      </td>
    </tr>
  </tbody>
</table>


<script>
  function format(d){
  // This function defines the style for an expanded table row
  var ret = '';
  var ret = "<div class='row'><div class='col-xs-12 col-sm-6'><table style='width:100%;margin-bottom:10px;'><tbody>";
    ret += '<tr><td><strong>Run name</strong></td><td>'+d.name+'</td></tr>';
    ret += '<tr><td><strong>Detectors</strong></td><td>';
    for(x=0;x<d.detectors.length;x+=1){
      ret+=d.detectors[x];
      if(x!=d.detectors.length) ret+=', ';
    }
    ret += '</td></tr>';
    ret += '<tr><td><strong>Data Period</strong></td><td>period 0</td></tr>';
    ret += '<tr><td><strong>Run Mode</strong></td><td>'+d.name+'</td></tr>';
    ret += '<tr><td><strong>Starting User</strong></td><td>'+d.user+'</td></tr>';
    ret += '<tr><td><strong>Start Date</strong></td><td>';
console.log(d.starttimestamp);
    var start = new Date(d.starttimestamp['$date']);
    
    ret += start.getUTCFullYear() +
            "/"+ (start.getUTCMonth()+1) +"/"+ start.getUTCDate() + " " +
            start.getUTCHours() + ":" + start.getUTCMinutes() + ":" + 
            start.getUTCSeconds();    
    ret += '</td></tr>';   
    ret += '<tr><td><strong>End Date</strong></td><td>';
    if('endtimestamp' in d){
       var end = new Date(d.endtimestamp['$date']);

    ret += end.getUTCFullYear() +
            "/"+ (end.getUTCMonth()+1) +"/"+ end.getUTCDate() + " " +
            end.getUTCHours() + ":" + end.getUTCMinutes() + ":" +
            end.getUTCSeconds();
    }
    else ret+='None';
    ret+='</td></tr>';
    ret+='</tbody></table></div>';
    ret+= '<div class="col-xs-12 col-sm-6"><table style="width:100%;margin-bottom:10px;"><tbody>';
    ret += '<tr><td>Valid triggers</td><td>NA</td></tr>';
    ret += '<tr><td>Good run?</td><td>Sure</td></tr>';
    ret += '<tr><td>Raw data location</td><td>NA</td></tr>';
    ret += '<tr><td>Processed data locations</td><td>NA</td></tr>';
    ret += '<tr><td>More</td><td>...</td></tr>';
    ret += '<tr><td>More</td><td>...</td></tr>';
    ret += '<tr><td>More</td><td>...</td></tr>';
    ret+='</tbody></table></div></div>';


    
    ret += '<div class="panel-group" style="width:100%;margin:0;" id="accordion" role="tablist" aria-multiselectable="true">';
  /*    ret +='<div class="panel panel-default">   <div class="panel-heading" role="tab" id="headingOne"> <h4 class="panel-title"> <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true"   aria-controls="collapseOne">Info</a></h4> </div><div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">  <div class="panel-body">';
*/	    
    //INFO BODY

    ret+='</div></div></div>';

      ret +='<div class="panel panel-default" style="margin-bottom:5px;">   <div class="panel-heading" role="tab" id="headingTwo"> <h4 class="panel-title"> <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" aria-expanded="false"   aria-controls="collapseTwo">JSON</a></h4> </div><div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">  <div class="panel-body">';
    // JSON
	 ret+='<pre class="prettyprint" style="width:100%;max-height:400px;overflow-y:scroll;">' + JSON.stringify(d, null, '\t') + "</pre>";
    ret+='</div></div></div>';


    ret +='<div class="panel panel-default" style="margin-bottom:5px;">   <div class="panel-heading" role="tab" id="headingThree"> <h4 class="panel-title"> <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="false"   aria-controls="collapseThree">Comments</a></h4> </div><div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">  <div class="panel-body">';

 // Comments
    if("comments" in d){
    for(i=0;i<d.comments.length;i+=1){
	ret += '<div class="bubble"><p><b>';
        ret += d.comments[i]["user"];
        ret += ' </b>&nbsp; wrote on &nbsp; ';
        var date = new Date(d.comments[i]["date"]['$date']);

	ret += date.getUTCDate() + "." + (date.getUTCMonth()+1) + 
               "." + date.getUTCFullYear() + " at " + 
            date.getUTCHours() + ":" + date.getUTCMinutes() + ":" +
            date.getUTCSeconds();
        ret += '<p>{% autoescape off %}';
        ret += d.comments[i]["text"];
        ret += '{% endautoescape %}</p></p></div>';
    }
    }
    else 
       ret += '<p>No comments yet</p>';
    // Form for new comment
    ret += "<form action='/log/new_comment/' method='post'>" +
      "{% csrf_token %}" +
      '<textarea id="' + d._id['$oid'] + '_formtext" style="width:100%" name="content"></textarea>' +
      '<br>' +
      '<input style="margin-top:10px;" type="hidden" name="redirect_url" value="{{ request.get_full_path }}"/>' +
      '<button class="btn btn-info" type="submit" value="' + d._id['$oid'] + '" name="log_id" style="margin-bottom:15px;">New comment</button>';
      
      ret +=  '</form>';
        ret+='</div></div></div>';
    ret += '</div>'; //close panel group

  return ret;
  }
  
  $(document).ready(function(){

  // For row selection and list printing
  var selected = [];
  var thedata = {{ runs_list|safe }};
  var table = $('#runstable').DataTable({
	"dom": 'T<"clear">lfrtip',
     "data": thedata,
     "aLengthMenu": [
        [ 50, 100, 200, 500, -1],
        [ 50, 100, 200, 500, "All"]
	],
     "columns": [
      {
         "className": 'runs-expand',
         "orderable": false,
         "data":      null,
         "defaultContent": '',
         "width":     '20px'
      },
      {
         "data":    "name"
      },
      { 
         "data":    "starttimestamp",
         "width":   "15%",
         "render":  function(data){
                      var m = new Date(data['$date']);
                      var dateString = m.getUTCFullYear() + "/" +
                                       (m.getUTCMonth()+1) + "/" + 
                                       m.getUTCDate() + " " + 
                                       m.getUTCHours() + ":" + 
                                       m.getUTCMinutes() + ":" + 
                                       m.getUTCSeconds();
                      return dateString;
                     }
       },
       {
          "data":    "runmode",
       },
       {
          "data":    "comments",
          "width":   '10px',
          "render":  function(data){
                        if(data==null) return 0;
                        return data.length;
                     }
        }
     ],
     "order":     [[ 2, "desc" ]],
     "iDisplayLength": 100,
//     "rowCallback": function( row, data ) {
  //          if ( $.inArray(data.DT_RowId, selected) !== -1 ) {
    //            $(row).addClass('selected');
      //      }
      //  },
     "tableTools": {
        sRowSelect: 'multi',
        aButtons: [
          {
               sExtends: 'select_all',
               sButtonText: 'Select All',
               fnClick: function (nButton, oConfig, oFlash) {
               TableTools.fnGetInstance('runstable').fnSelectAll(true);
            }
          }, 
	  "select_none",
        ]
      },
    }); // end table declaration
      
  // Event listener for opening and closing details
  $('#runstable tbody').on('click', 'td.runs-expand', function(){
  
      var tr = $(this).closest('tr');
      var row = table.row(tr);

      if( row.child.isShown() ){
         // The row is open. Close it
         row.child.hide();
         tr.removeClass('shown');
      }
      else {
         // Open the row
         row.child( format(row.data()) ).show();
         tr.addClass('shown');
      }
  
  }); // End expand click listener

/*  $('#runstable tbody').on('click', 'tr', function () {
        var id = this.id;
        var index = $.inArray(id, selected);

        if ( index === -1 ) {
            selected.push( id );
        } else {
            selected.splice( index, 1 );
        }
 
        $(this).toggleClass('selected');
    } );
*/

$('#download_as_runlist').click( function () {

   console.log(table.rows('.selected').data());

   var runsList = "";
   for(i=0; i<table.rows('.selected').data().length; i+=1){
       runsList+=table.rows('.selected').data()[i]['name']+"\n";
   }
   console.log(runsList);

  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' 
					+ encodeURIComponent(runsList));
  element.setAttribute('download', 'runs.txt');

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
} );


    }); // end document ready function

</script>

<script type="text/javascript">
// Get a runs list
function DownloadList(whichone){
    startdate = document.getElementById("id_startdate").value;
    enddate   = document.getElementById("id_enddate").value;
    runmode   = document.getElementById("id_runmode").value;
    var urlstart = "{% url 'download_list' %}";
    var url = "?which=";
    url += whichone;
    url += "&startdate=";
    url += encodeURIComponent(startdate);
    url += "&enddate=";
    url += encodeURIComponent(enddate);
    url += "&runmode=";
    url += runmode;
    console.log(url);
    console.log("What does it do with %2F for example");
    var html = '<iframe src="' + urlstart + url + '" style="display: none;" ></iframe>';
    console.log(html);
    $("body").append(html);

};

</script>
{% endblock %}

