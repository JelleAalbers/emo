{% extends "base.html" %}
{% load staticfiles %}
{% block head %}
<style type="text/css">

.plot_link{
 cursor: pointer;
}
</style>

    <script src="{% static "js/bokeh-0.9.0.min.js"%}"></script>
<link rel="stylesheet" href="{% static "css/bokeh-0.9.0.min.css" %}"/>


{% endblock %}
{% block content %}

    <div class="col-xs-3" style="padding-top:5px;">
      <div class="panel-group" id="accordion_toplevel" role="tablist"
           aria-multiselectable="false">
	<div class="panel panel-default">	 
	  <div class="panel-heading" style="background-color:#5992c2;color:#FFFFFF">
            <h4 style="margin:0">
	      <a role="button" data-toggle="collapse" 
		 data-parent="#accordion_toplevel"
                 href="#collapseDataChooser" aria-expanded="true"
                 aria-controls="collapseDataChooser" style="color:white">
		Step 1: Choose your data
	      </a>
	    </h4>
	  </div>
	  <div id="collapseDataChooser" class="panel-collapse collapse in"
               role="tabpanel" aria-labelledby="headingDataChooser">
	    <form method="POST" action="" id="filter_form">
              {% csrf_token %}
	      
	      <span class="list-group-item" style="border:0">
		<strong>Data range </strong>
		<span><br>
		  <input type="radio" name="runs_sel"  value="all" 
			 checked="checked" /> 
		  All runs </span>	    
		<span><br>	    
		  <input type="radio" name="runs_sel"  
			 value="current" /> Current run </span>
		<br>
		<span>
		<input type="radio" name="runs_sel"  value="range" /> Date range
		</span>	  
		<br>
		<div class="row">
		  <div class="col-xs-2 col-xs-offset-1">From </div>
		  <div class="col-xs-8">
		    <input type="date" name="start_date">
		  </div>
		</div>
		<div class="row">
		  <div class="col-xs-2 col-xs-offset-1">To </div>
		  <div class="col-xs-8">
		    <input type="date" name="end_date">
		</div>
		</div>
		
              </span>
	      <span class="list-group-item" style="border:0">
		<div class="row">
		  <div class="col-xs-3"><strong>Mode:</strong></div>
		  <div class="col-xs-9">
		    <select id="run_mode_tpc" name="run_mode_tpc"></select>
		</div>
		</div>
		
	      </span>
	      <div class="col-xs-12">
		<button type="submit" 
			class="btn btn-success pull-right">Process</button>
	      </div>
	    </form>
	  </div>
	  
	  <div class="panel panel-default">				  
	    <div class="panel-heading" 
		 style="background-color:#5992c2;color:#FFFFFF">	      
              <h4 style="margin:0">
		<a role="button" data-toggle="collapse" 
		   data-parent="#accordion_toplevel"
		   href="#collapseSpectrumChooser" aria-expanded="true"
		   aria-controls="collapseSpectrumChooser" style="color:white"
		   id="second_header">
		  Step 2: Choose your spectrum
		</a>
	      </h4>	     
            </div>	  
	  </div>
	  <div id="collapseSpectrumChooser" class="panel-collapse collapse"
               role="tabpanel" aria-labelledby="headingSpectrumChooser">
	    <div class="panel-group" id="accordion" role="tablist" 
		 aria-multiselectable="true">
	      <div class="panel panel-default">
		<div class="panel-heading" 
		     style="background-color:#4fa783;color:#FFFFFF;"
		     role="tab" id="headingOne">
		  <h4 class="panel-title">
		    <a role="button" data-toggle="collapse" 
		       data-parent="#accordion" 
		       href="#collapseOne" aria-expanded="true" 
		       aria-controls="collapseOne">
		      1-D Histograms
		    </a>
		  </h4>
		</div>
		<div id="collapseOne" class="panel-collapse collapse in" 
		     role="tabpanel" aria-labelledby="headingOne">
		  <div class="panel-body" id="h1">
		    List spectra here
		  </div>
		</div>
	      </div>
	      <div class="panel panel-default">
		<div class="panel-heading" 
		     style="background-color:#4fa783;color:#FFFFFF;"
		     role="tab" id="headingTwo">
		  <h4 class="panel-title">
		    <a class="collapsed" role="button" data-toggle="collapse" 
		       data-parent="#accordion" href="#collapseTwo" 
		       aria-expanded="false" aria-controls="collapseTwo">
		      2-D Histograms
		    </a>
		  </h4>
		</div>
		<div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" 
		     aria-labelledby="headingTwo">
		  <div class="panel-body" id="h2">
		    
		  </div>
		</div>
	      </div>
	      <div class="panel panel-default">
		<div class="panel-heading" 
		     style="background-color:#4fa783;color:#FFFFFF;"
		     role="tab" id="headingThree">
		  <h4 class="panel-title">
		    <a class="collapsed" role="button" data-toggle="collapse" 
		       data-parent="#accordion" href="#collapseThree" 
		       aria-expanded="false" aria-controls="collapseThree">
		      Scatter Plots
		    </a>
		  </h4>
		</div>
		<div id="collapseThree" class="panel-collapse collapse" role="tabpanel" 
		     aria-labelledby="headingThree">
		  <div class="panel-body" id="scatter">
		    
		  </div>
		</div>
	      </div>
	    </div>
	  </div>
	</div>
      </div>
    </div>
      <div class="col-xs-9" id="plot_div">
      </div>
      


<script type="text/javascript">
  var run_mode_list_url = "/config/fetch_mode_list";
  //var aggregate_list_url = "/monitor/get_aggregate_list";
  //var aggregate_data_url = "/monitor/get_aggregate_plot/";
  var aggregate_data_url = "/monitor/get_available_plots";
  var plot_data_url="/monitor/get_plot";
  var url_end = "";

  function DrawPlot(name){

  //we needthe same filterthat there was,so keepurl_end
  var url = plot_data_url + url_end;

  //we needto add the actual name of the plot
  url += "name=";
  url += name;
  url += ";";

  //Now get the data from the server
  $.getJSON(url, function(data){

     console.log(data);
     document.getElementById("plot_div").innerHTML = "";
  $("#plot_div").append(data['div']);
  $("#plot_div").append(data['script']);
  for(var idex=0; idex<Bokeh.Collections('Plot').length;idex+=1){
			 Bokeh.Collections('Plot').at(idex).set("plot_width", $("#plot_div").width());
			 Bokeh.Collections('Plot').at(idex).set("plot_width", $("#plot_div").width());
}

  });

  }
  
  $('#filter_form').submit(function(e){
     e.preventDefault();  
     document.getElementById("second_header").click();
     console.log(e);

     // Get value of runs_sel radio
     runs_sel = $('input[name="runs_sel"]:checked').val();
     run_mode = $("#run_mode_tpc").val();

     var start_date = null;
     var end_date = null;

     if(runs_sel == "range"){
       start_date = $("#start_date").val();
       end_date = $("#end_date").val();
     }     
     console.log(start_date);

     // Create a GET request with the data embedded
     url_end = "";
     if(runs_sel == "all")
        url_end += "?selection=all;";
     else if(runs_sel =="current")
        url_end += "?selection=current;";
     else {
        url_end += "?selection=range;";
        if(start_date != null)
           url_end += "start_date=" + start_date;
        if(end_date != null)
           url_end += "end_date=" + end_date;
     }
     if(run_mode != "All")
        url_end += "run_mode=" + run_mode;
    
     var total_url = aggregate_data_url + url_end;
     $.getJSON(total_url,function(data){
         console.log(data);
         for (var key in data) {                        
             if (data.hasOwnProperty(key)) {
                var html_line = "<ul>";
                for(var idex=0; idex<data[key].length; idex+=1){
                    html_line += "<li><a class='plot_link' onclick='DrawPlot(" + '"' + 
				data[key][idex] + '");' + "'>"+ data[key][idex] + 
                                "</a></li>";
                }
                html_line += "</ul";
                document.getElementById(key).innerHTML = html_line;
             }
         }
     });
  });

      $(function(){

         // Fill run mode list
         $.getJSON(run_mode_list_url, function(data){
             if(data!=null){
                if("tpc" in data){
                  $("#run_mode_tpc").append("<option name='all';'>All</option>");
                    for(x=0;x<data['tpc'].length;x++){
                        $("#run_mode_tpc").append("<option name='"
				+ data['tpc'][x] + "'>"+
                                data['tpc'][x]+"</option>");
		    }
                }
          }});

	
    /*$.getJSON(aggregate_list_url, function(plotdata){

         for(x=0; x<plotdata.length; x+=1){

             query = aggregate_data_url + "?name=" + plotdata[x];
              widget_id = "plot_" + x.toString();
              $.getJSON(query, function(aggregate_data){

                    if (aggregate_data != null && aggregate_data != {}) {
                        console.log(aggregate_data);
                        $("#grid").append(MakeGridTemplate(aggregate_data['div']));
                        $("body").append(aggregate_data['script']);

                    }
              }); // End second getJSON

              } // End for
          }); // End first getJSON
*/
    });

    </script>
<script id="js_div"></script>

{% endblock %}
