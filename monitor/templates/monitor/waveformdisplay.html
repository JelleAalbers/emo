{% extends "base.html" %}
{% load staticfiles %}
{% block head %}

<script src="{% static "js/bokeh-0.9.0.min.js"%}"></script>
<script src="{%  static "bootstrap-fileinput-master/js/fileinput.min.js"%}"></script>
<link rel="stylesheet" href="{% static "bootstrap-fileinput-master/css/fileinput.min.css" %}"/>
<link rel="stylesheet" href="{% static "css/bokeh-0.9.0.min.css" %}"/>
    <link href="{% static "emo/css/emo_logstyle.css" %}" rel="stylesheet">

    <style type="text/css">

  .Loading {
      display:    none;
      position:   fixed;
      z-index:    1000;
      top:        0;
      left:       0;
      height:     100%;
      width:      100%;
      background: rgba( 255, 255, 255, .8 )
      url('{{STATIC_URL}}images/ajax-loader.gif')
      50% 50%
      no-repeat;
  }
    .emobox{
        background-color: white;
        border-width: 1px;
        border-color: #444444;
        border-style: solid;
        min-height:40px;
        margin: 10px;
    }
</style>
    {%  endblock %}
{% block content %}
    <div class="Loading">Loading Next Event</div>
    <div class="col-xs-12 emo-search-bar" style="position:absolute;z-index:2;">
        <div class="row">
            <div class="col-xs-12 col-sm-6" style="line-height:40px;">
                <strong>Run: </strong>
                <span id="run_name" style="font-size:12pt;"></span>&nbsp;&nbsp;
                <strong>Event: </strong>
                <span style="font-size:12pt" id="event_number"></span>&nbsp;&nbsp;
                <strong>Collected: </strong><span id="event_date"></span>
            </div>
            <div class="col-xs-12 col-sm-6 text-right">
                <button class="btn btn-info btn-sm" style="height:30px;margin:6px;"
                        onclick="update_data()">Newest Event</button>
                <button class="btn btn-info btn-sm" style="height:30px;margin:6px;"
                        onclick="loadjson()">Load from file</button>
                <button class="btn btn-info btn-sm" style="height:30px;margin:6px;"
                        onclick="savejson()">Save to file</button>
            </div>
        </div>
    </div>
    <div class="container" style="margin-top:50px;width:100%;">
    <div class="col-xs-12 emobox" id="full_waveform"></div>

    <div class="col-xs-12 col-sm-12 emobox" id="hit_patterns"></div>
        </div>

<script type="text/javascript">

    var currentdata = null;
    var file = null;
    var data_url = "/monitor/get_event_for_display";
    $(document).ready(function() {
     //   update_data();
    });

    function update_data(){
        console.log("HERE");
         $.getJSON(data_url, function(data){
             console.log(data);
             draw_waveform(data);
             currentdata=data;
          });
    }
    function draw_waveform(data){

        document.getElementById("full_waveform").innerHTML = "";
        $("#full_waveform").append(data['div']);
        $("#full_waveform").append(data['script']);
        Bokeh.Collections('Plot').at(0).set("plot_width", $("#full_waveform").width());
        Bokeh.Collections('Plot').at(1).set("plot_width", $("#full_waveform").width());
        document.getElementById("hit_patterns").innerHTML = "";
        $("#hit_patterns").append(data['ddiv']);
        $("#hit_patterns").append(data['dscript']);
        document.getElementById("run_name").innerHTML = data['run_name'];
        document.getElementById("event_number").innerHTML = data['event_number'];
        document.getElementById("event_date").innerHTML = data['event_date'];

    }
    function unzip_waveform(waveform){
        x = [];
        y = [];
        time_bin = 0;
        for(i=0; i<waveform.length; i+=1) {
            if (waveform[i] != 'z') {
                x.push(time_bin);
                y.push(waveform[i]);
                time_bin += 1;
            }
        else {
                i += 1;
                nzeros = (waveform[i]);
                for (j = 0; j < nzeros; j += 1) {
                    x.push(time_bin);
                    y.push(0);
                    time_bin += 1;
                }
            }
        }
        return {x: x, y: y}
    }
function savejson(){

    if(currentdata != null){

        filename = "dump_run_" + currentdata['run_name'] + "_" + currentdata['event_number'] + ".json";
        var pom = document.createElement('a');
        pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(JSON.stringify(currentdata)));
        pom.setAttribute('download', filename);

        pom.style.display = 'none';
        document.body.appendChild(pom);

        pom.click();

        document.body.removeChild(pom);
  }

}

    function loadjson(){
        BootstrapDialog.show({ title: 'Load event from file',
			     message: '<input id="file-input-id" type="file"></input>' +
                 '<br><button type="button" class="close" data-dismiss="modal" aria-label="Close">' +
                 '<span aria-hidden="true">&times;</span></button>' +
                 '<button onclick="parse_file()" class="btn btn-info" class="close" data-dismiss="modal">Submiit</button>'
                }, function(){ $("#file-input-id").fileinput()}
			   );
    }
    function parse_file(path){
        path=document.getElementById("file-input-id");
        console.log(path.files);
        reader = new FileReader();
        reader.onload = function (e) {
                output = e.target.result;
                console.log(output);
            currentdata = JSON.parse(output);
            draw_waveform(JSON.parse(output));
        };//end onload()
            reader.readAsText(path.files[0]);
    }

</script>
{% endblock %}
