{% extends "base.html" %}
{% load staticfiles %}
{% block head %}
<script src="{% static "emo/js/daqcontrol.js" %}" type="text/javascript"></script>
<script src="{% static "js/jquery-ui.min.js" %}" type="text/javascript"></script>
<script src="{% static "js/lodash.full.js" %}" type="text/javascript"></script>
<script src="{% static "js/gridstack.min.js" %}" type="text/javascript"></script>
<script src="{% static "js/progressbar.min.js" %}" type="text/javascript"></script>
<script src="{% static "js/highcharts.4.2.5.js" %}" type="text/javascript"></script>
<script src="{% static "js/highcharts.4.2.5.exporting.js" %}" type="text/javascript"></script>
<script src="{% static "js/highcharts.4.2.5.offline-exporting.js" %}" type="text/javascript"></script>


<link href="{% static "emo/css/control.css" %}" rel="stylesheet">
<link href="{% static "css/jquery-ui.min.css" %}" rel="stylesheet">
<link href="{% static "css/gridstack.min.css" %}" rel="stylesheet">


{% endblock %}
{% block content %}

<!-- Title bar-->                                                                
<!--<div class="row"><h5>DAQ Run Control</h5></div>  -->

<div class="grid-stack" style="width:100%;margin-top:20px;margin-bottom:20px">

    <!-- THIS IS THE RATES WINDOW -->   
    <div class="grid-stack-item"
	 data-gs-x="0" data-gs-y="0"
	 data-gs-width="12" data-gs-height="4" data-gs-min-height="4"
	 data-gs-max-height="4">
      <div class="grid-stack-item-content gridbox" style="overflow-y:hidden">
	<div class="window-handle"></div>                                          
	<div class="window-content" id="rates_content">               
	  <div class="window-title" id="rates_title">             
            <div class="row" style="width:100%">                                                      
              <div class="col-sm-2 col-xs-12" style="min-width:180px;">
		<h4 style="padding:3px;margin:0"><strong>Rate History              
		</strong><div id="updatebar" style="display:inline-block;width:20px;height:20px"></div>       </h4>
              </div>                                                               
              <div class="col-sm-9 col-xs-12">
		<!--<div class="pull-right" style="padding-right:3px">-->
		<strong class="option-label">Options: </strong>                   
		<div class="btn-group" id="graphic_var_selector" role="group"
                     aria-label="...">
		  <button type="button btn-range" value="datarate"
			  class="btn btn-default var active">Data Rate</button>
		  <button type="button btn-range" value="bltrate"
			  class="btn btn-default var">BLT Rate</button>
		  <button type="button btn-range" value="cpu"
			  class="btn btn-default var">CPU Usage</button>
		  <button type="button btn-range" value="ram"
			  class="btn btn-default var">RAM Usage</button>
		</div>
		
		<!--<strong class="option-label">History: </strong>                    -->
		<div class="btn-group"                                             
                     id="time_range_selector" role="group">   
		  <button type="button btn-range" value=345600
                          class="btn btn-default btn-xs range">96 hours</button>
                  <button type="button btn-range" value=259200
                          class="btn btn-default btn-xs range">72 hours</button>
                  <button type="button btn-range" value=172800                     
                          class="btn btn-default btn-xs range">48 hours</button>   
                  <button type="button btn-range" value=86400                      
                          class="btn btn-default btn-xs active range">24 hours     
                  </button>                                                        
                  <button type="button btn-range" value=21600                      
                          class="btn btn-default btn-xs range">6 hours</button>    
                  <button type="button btn-range" value=3600                       
                          class="btn btn-default btn-xs range">1 hour</button>     
		</div>                                                             

<!--		<strong class="option-label">Frequency: </strong>                  -->
		<div class="btn-group" id="time_bin_selector"                      
                     role="group">                                                 
                  <button type="button btn-range" value=600                        
                          class="btn btn-default active bin">10 min</button>       
                  <button type="button btn-range" value=120                        
                          class="btn btn-default bin">2 min</button>               
                  <button type="button btn-range" value=30                         
                          class="btn btn-default bin">30 sec</button>              
                  <!--<button type="button" value=10                               
                      class="btn btn-default bin">10 sec</button>-->               
		</div>                                                             
<!--		</div>-->
              </div>                                                               
            </div>                                                                 
          </div>                                                                   
	  <div id="rates_panel" style="position:relative;height:200px;width:100%;">
	    
	  </div>                                                                     
	</div>
      </div>
    </div>
    <!-- END RATES WINDOW -->    
    
    <!-- THIS IS THE LOG WINDOW -->                                              
    <div class="grid-stack-item"
         data-gs-x="0" data-gs-y="6"
         data-gs-width="6" data-gs-height="4">
      <div class="grid-stack-item-content gridbox" id="logwindowgs">
	<div class="window-handle"></div>                                          
	<div class="window-content" style="overflow-y:hidden">
	  <div class="window-title" id="log_title" style="padding-top:2px;">
	    <form id="new_log_entry" class="form-inline" style="width:100%"
                  action="/log/new_log_entry" 
                  method='post'>{% csrf_token %}
	      <div class="form-group" style="width:80%">
		<label for="new_comment_text" style="width:20%;padding-left:5px;">Logbook: </label>
		<input type='text' id='new_comment_text' name='message' 
		       class='form-control'  placeholder='Make a log entry...' style="width:75%">	
	      </div>	      
	      <button class='btn btn-default' 
		      style="background-color:white;width:15%;min-width:50px;"
		      type="submit" value='Submit'>Submit</button>   	 
	      <input type="hidden" name="redirect" value="none"/>	  
	    </form>	   
	  </div>
	  <div id="message_panel" style="overflow-y:scroll;">
	  </div>
        </div>
      </div>
    </div>

    <!-- END LOG WINDOW -->   
    <!-- THIS IS THE PLAYLIST WINDOW -->                                         
    <div class="grid-stack-item"
         data-gs-x="7" data-gs-y="5"
         data-gs-width="6" data-gs-height="1">
      <div class="grid-stack-item-content gridbox">	
	<div class="window-handle"></div>                                          
	<div class="window-content"></div>                                         
      </div>
    </div>
    <!-- END PLAYLIST -->                                                        

    <!-- THIS IS THE TPC WINDOW -->
    <div class="grid-stack-item"
         data-gs-x="0" data-gs-y="9"
         data-gs-width="6" data-gs-height="3" data-gs-min-width="4">
      <div class="grid-stack-item-content gridbox">
        <div class="window-handle"></div>
	<div class="window-content" style="overflow-y:hidden" id="tpc_window">
	  <div class="window-title" id="tpc_title" style="padding-top:2px;">
	    <h3>TPC</h3>
	  </div>
	  <div class="window-title" id="tpc_title_2" style="padding-top:2px;">       
          </div>
	  <div id="tpc_content" style="width:100%;overflow-y:scroll">
	  </div>
	</div>
      </div>
    </div>
    <!-- END TPC -->
    <!-- THIS IS THE MUON VETO WINDOW -->
    <div class="grid-stack-item"
         data-gs-x="7" data-gs-y="9"
         data-gs-width="6" data-gs-height="3" data-gs-min-width="4">
      <div class="grid-stack-item-content gridbox">
        <div class="window-handle"></div>
	<div class="window-content" style="overflow-y:hidden" id="mv_window">
	  <div class="window-title" id="mv_title" style="padding-top:2px;">
            <h3>Muon Veto</h3>
          </div>
	  <div class="window-title" id="mv_title_2" style="padding-top:2px;">
          <div id="mv_content"style="width:100%">
          </div>

	</div>
      </div>
    </div>
    <!-- END MUON VETO -->

  </ul>                                                                          
</div>  

<script>                                                                         

  // DEFAULTS
  var chartdiv = "rates_panel";
  var updateFreq = 1000;          // 5 second update polling
  var updateCounts = 10;
  var pointUpdateUrl = "/control/get_node_updates";
  var historyUrl = "/control/get_node_history";
  var dataUrl = "/control/get_status_update";
  var logUrl = "/log/get_dispatcher_log";
  var currentShifterUrl = "/supermanrequest";
  var chart;
  var graphic_range = (24*60*60).toString();
  var graphic_bin = "600";
  var graphic_var = "datarate";
  var feedback_count = 0;
  var feedbackURL = "/control/run_start_feedback";
  var feedback_html = "";
  var table_div = "queue_table_body";
  var queueURL="/control/get_queue_list";
  var queue_update_url="/control/set_queue_list";
  var display_counter=0;

  // The progress bar update for page refresh

  var pageupdatebar = new ProgressBar.Circle("#updatebar", {
  strokeWidth: 10,
  easing: 'easeInOut',
  duration: 1400,
  color: '#5992c2',
  trailColor: '#eee',
  trailWidth: 1,  
  svgStyle: null
});

  function redraw_graphic(data, callback){

        var thechart=$("#rates_panel").highcharts();
        while( thechart.series.length > 0 ) {
            thechart.series[0].remove( false );
        }
        var units = {"datarate": "MB/s", "bltrate": "blt/s"};
        thechart.yAxis[0].setTitle({ text: "rate ("+units[graphic_var]+")" });

  var historyUrlWithOptions = historyUrl + "?range=" + graphic_range + "&bin=" + graphic_bin+"&var="+graphic_var;
        if(data == null)
        $.getJSON( historyUrlWithOptions, function(newdata) {

            loadData(thechart, newdata, function(thechart){callback()}); return;
                                    });
        else
           loadData(thechart, data, function(thechart){});

callback();
    }


  function update_graphic(callback){
  var historyUrlWithOptions = historyUrl + "?range=" + graphic_range + "&bin=" + graphic_bin+"&var="+graphic_var;
       $.getJSON( historyUrlWithOptions, function(data) {
          var thechart=$("#rates_panel").highcharts();
          if(thechart.series.length != data.length){
console.log("made here");
             redraw_graphic(data, callback);
             return;
          }
          var units = {"datarate": "MB/s", "bltrate": "blt/s"};
          thechart.yAxis[0].setTitle({ text: "rate ("+units[graphic_var]+")" });

          for( x=0; x<data.length; x++ ){
              thechart.series[x].update({
                data: data[x]["data"],
              },true);
          }
          callback();
      });
//  callback();  

  }
  function UpdatePage( thechart ){
  update_graphic(function(){				   
    DrawLogWindow( "message_panel", logUrl, function(){
       UpdateDetectorTextPretty(dataUrl, pointUpdateUrl, "tpc_content", "mv_content", 
				   "tpc_title", "mv_title", "tpc_title_2", 
				   "mv_title-2",
	function(){
       var updatecounter=0;
       timerLoop(updatecounter, thechart);      
				   });
  });
  });
  }
  function timerLoop(progress, thechart){
console.log(progress);
    if(progress==updateCounts){
          pageupdatebar.animate(1.);
          UpdatePage( thechart );
       }
   else{
      pageupdatebar.animate(progress/updateCounts);
      progress +=1;
      setTimeout( function(){timerLoop(progress, thechart);}, updateFreq);
    }
   }

				   
  function MakeGrid(){
   console.log($("#content").innerWidth());
  var gridsize = Math.floor(($("#content").innerWidth()-20)/4);                      
  console.log(gridsize);
  gridsize-=20;
  // GET HEIGHT
  height = 50;
				// Check rates
  ratesheight = $("#rates_panel").innerHeight() + $("#rates_title").innerHeight();
  if(ratesheight > height)
    height = (ratesheight+4)/5;
    //height+=4; // for border
    //height = 50;
  $(".grid-stack").gridstack({                                                     

     cellHeight: height,
     handle: ".window-handle",

  });                                                                              
  }
  
    $(function(){ //DOM Ready

var frm = $('#new_log_entry');
     frm.submit(function(){
        if(document.getElementById("new_comment_text").value == "")
    return false;
    $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
           success: function(data)
           {
               DrawLogWindow("message_panel", logUrl, function(){}); 
           }
         });
    document.getElementById("new_comment_text").value="";
    return false;
     });

  MakeGrid();
    ResizeDetailWindows();
  drawChart( chart, chartdiv, graphic_var, function(thechart) {
                 UpdatePage( thechart );
$('.grid-stack').on('resizestop', function(event, ui) {
   ResizeLogWindow();
    ResizeDetailWindows();
});    
  });                                                                              

});

$(".nav a").on("click", function(){
   $(".nav").find(".active").removeClass("active");
   $(this).parent().addClass("active");
});
$(".btn-group button").on("click", function() {
    $(this).parent().find(".active").removeClass("active");
    $(this).addClass("active");
    $(this).blur();
    if ($(this).hasClass("range"))
				   graphic_range = $(this)[0].value;
    else if($(this).hasClass("var"))
				   graphic_var = $(this)[0].value;
    else
        graphic_bin = $(this)[0].value;
    //console.log($(this)[0].value);

});

function ResizeLogWindow(){
var hheight = $("#log_title").height();
var theight = $("#logwindowgs").height();
var wantheight = theight - hheight;
$("#message_panel").height(wantheight);
}
function ResizeDetailWindows(){
    var hheight = $("#tpc_title").height();
    var theight = $("#tpc_window").height();
    var wantheight = theight - hheight;
    $("#tpc_content").height(wantheight);
    hheight = $("#mv_title").height();
    theight = $("#mv_window").height();
    var wantheight = theight - hheight;
    $("#mv_content").height(wantheight);

}
function DrawLogWindow( logdiv, Url, callback ) {
    ResizeLogWindow();
    $.getJSON(Url, function(data){
    var html_string = "<table class='table table-striped table-condensed borderless'><tbody>";
        for ( x=0; x<data.length; x+=1 ){
	   var lcolor = "ccdd00";
           var p = data[x]['priority'];
          if(p==0) lcolor="5992c2";           
	  else if(p==2 || p==7) lcolor="ffd800";
	  else if(p==3 || p==4 || p==8 || p==9) lcolor="e86850";
	  else if(p==5) lcolor="587058";
				  
				  html_string += "<tr><td style='width:150px'>" + (new Date(data[x]['time']['$date'])).toISOString().slice(0,16) + "</td>" +
                                  "<td style='width:100px'><strong>" + data[x]['sender'] + "</strong></td>" +
                                  "<td class='hashes'>" + data[x]['message'] + "</td><td style='width:5px;background-color:#"+lcolor+"'></td></tr>";
				  }
				  html_string += "</tbody></table>"
	document.getElementById( logdiv).innerHTML = html_string;
	//			              $(".hashes").linkify(toHashtagUrl);
          callback();
      });
  }        
</script>     
{% endblock %}
