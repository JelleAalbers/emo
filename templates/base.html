{% load url from future %}
{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">  
    <title>XENON1T Online Monitoring - Powered by emo</title>     
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <meta name="description" content="XENON1T Data Monitor">    
    <meta name="author" content="Daniel Coderre" >
    
    <!-- Declare here any global styles all classes need -->
    <link href="{% static "bootstrap/css/bootstrap.min.css" %}" rel="stylesheet">
	 <link href="{% static "emo/css/emo_navbar.css" %}" rel="stylesheet">
	 <link href="{% static "css/devoops.css" %}" rel="stylesheet"> 
	 <link href="{% static "emo/css/emo_runslist.css" %}" rel="stylesheet">
	 <link href="{%  static "font-awesome-4.1.0/css/font-awesome.min.css" %}" rel="stylesheet">

    <!-- Declare here any global javascript -->
    <script src="{% static "jquery/js/jquery.min.js" %}"></script>

    <script src="{% static "Highcharts-4.0.1/js/highcharts.js" %}"></script>

    
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}"></script>
     <script src="{% static "bootstrap/js/bootstrap-dialog.min.js" %}"></script>
    <link rel="stylesheet" href="{% static "google-code-prettify/prettify.css" %}">
	<script src="{% static "google-code-prettify/prettify.js" %}"></script>

	<script type="text/javascript">  var global_can_start_runs = false;</script>

{% block head %}
{% endblock %}

  </head>

  <body>
   	
   	<!-- Make the navigation bar -->	
   		<header class="navbar navbar-fixed-top emo-navbar">   	
   			<div class="navbar-header" style="height:40px">
   				<button type="button" class="navbar-toggle"
               	   data-toggle="collapse" data-target=".navbar-collapse">
      				<span class="icon-bar"></span>                                           
          		   <span class="icon-bar"></span>                                           
         		   <span class="icon-bar"></span>
     	   	  </button>
     	   	  
   				<a class="navbar-brand toggle-sidebar" style="cursor:pointer;">
   				XENON1T Data Acquisition 
   				</a>
   			</div>
   		
									
				
   				
   			<div class="collapse navbar-collapse">
          		{% block login_toggle %}
          		{% include "login_toggle.html" %}
          		{% endblock %}
			   		{% if user.is_authenticated %}
	<ul class="navbar-right">
				<ul class="nav navbar-nav">
  				<li class="dropdown">
    				<a class="dropdown-toggle" id="last_update_nav" data-toggle="dropdown"
       					href="#">Connected <span id="contact"></span></a>
    				<ul class="emo-status-menu dropdown-menu" id="contact_more" role="menu" aria-labelledby="last_update">
						More info here
					</ul>
  				</li>
			</ul>
			<ul class="nav navbar-nav">
  				<li class="dropdown">
    				<a class="dropdown-toggle" id="daq_status_nav" data-toggle="dropdown"
       					href="#"> DAQ Status <span id="status"></span></a>
    				<ul class="emo-status-menu dropdown-menu" style="min-width:600px;padding-top:0px;" id="status_more" role="menu" aria-labelledby="daq_status_nav">
						More info here
					</ul>
  				</li>
			</ul>
			<ul class="nav navbar-nav">
  				<li class="dropdown">
    				<a class="dropdown-toggle" id="open_alerts_nav" data-toggle="dropdown"
       					href="#"> Open Alerts <span id="alerts"></span></a>
    				<ul class="emo-status-menu dropdown-menu" id="alerts_more" role="menu" aria-labelledby="opern_alerts_nav">
						More info here
					</ul>
  				</li>
			</ul></ul>
			{% endif %}
		</div>
	</header>
   		
   		<!-- If user is not logged in just show them a pretty picture -->
   		{% if user.is_authenticated %}
			<!-- Sidebar -->
	<div id="main" class="container-fluid" style="margin-top:40px;">
		<div class="row">
     		<div id="sidebar-left" class="col-xs-2 col-sm-2">
        		<ul class="nav main-menu">

				<li>
					<a href="/control/reader" class="ajax-link">
						<span class="hidden-xs">Control Panel</span>
					</a>
				</li>
				<li class="dropdown">
					<a href="#" class="dropdown-toggle">
						<span class="hidden-xs">Diagnostics</span>
					</a>
					<ul class="dropdown-menu">
						<li><a class="ajax-link" href="/monitor/waveforms">Live Waveforms</a></li>
						<li><a class="ajax-link" href="/monitor/pax_display">Live pax Displays</a></li>
						<li><a class="ajax-link" href="/monitor/diagnostics">Data Monitoring</a></li>
						<li><a class="ajax-link" href="/monitor/runstats">Run Parameters</a></li>
						<li><a class="ajax-link" href="/monitor/noise">Noise Spectra</a></li>
						<li><a class="ajax-link" href="/monitor/hardware">DAQ Hardware</a></li>
						<li><a class="ajax-link" href="/monitor/scope">Live Scope</a></li>
						<li><a class="ajax-link" href="/monitor/eventdisplay">Event Display</a></li>
					</ul>
				</li>
				<li>
					<a class="ajax-link" href="/runs">
						 <span class="hidden-xs">Runs Database</span>
					</a>
					
				</li>
				<li>
					 <a class="ajax-link" href="/log">
						 <span class="hidden-xs">Logbook</span>
					</a>
				</li>
				<li class="dropdown">
					<a href="#" class="dropdown-toggle">
						 <span class="hidden-xs">Super User</span>
					</a>
					<ul class="dropdown-menu">
						<li><a class="ajax-link" href="/config/">Run Configuration</a></li>
						<li><a class="ajax-link" href="https://mms.mongodb.com">MMS (external link)</a></li>
					</ul>
				</li>
				<li class="dropdown">
					<a href="#" class="dropdown-toggle">
						 <span class="hidden-xs">About/Help</span>
					</a>
					<ul class="dropdown-menu">
						<li><a class="ajax-link" href="/docs">Documentation</a></li>
						<li><a class="ajax-link" href="/docs/contact">Contact</a></li>
						<li><a class="ajax-link" href="/docs/about">About</a></li>
					</ul>
				</li>
				
				</ul>
			</div>	
   		<div id="content" class="col-xs-12 col-sm-10"><!-- col-sm-offset-2">-->
			{% block content %}
			<h4 style="margin:2%">Welcome! Please choose a link to begin. </h4>
			{% endblock %}
			</div>
			</div>
   		{% else %}
   		<div id="content" class="col-xs-12 col-sm-12">
   		<br><br><br>
   			<h5>Welcome to the XENON1T data monitor. Please log in to view content.</h5>
   			<br>
   			<h6>If you are here by mistake, maybe you'd rather check out our <a href="http://www.xenon1t.org"> public page</a>
   			</h6>
   		</div>
			{% endif %}
			

		</div>	

  </body>

<script>
// For google code prettification
  !function ($) {
    $(function(){
      window.prettyPrint && prettyPrint()
    })
  }(window.jQuery)
</script>

<script type="text/javascript">
  // Everything in this script tag borrowed (and modified) from devoops. http://devoops.me
  
  // Toggle the sidebar
  $('body').on('click', '.toggle-sidebar', function (e) {
  e.preventDefault();
     $('div#main').toggleClass('sidebar-show');  
  });
	
  // Menu handling
  $('.main-menu').on('click', 'a', function (e) {
     var parents = $(this).parents('li');
     var li = $(this).closest('li.dropdown');
     var another_items = $('.main-menu li').not(parents);
     another_items.find('a').removeClass('active');
     another_items.find('a').removeClass('active-parent');
     if ($(this).hasClass('dropdown-toggle') || $(this).closest('li').find('ul').length == 0) {
        $(this).addClass('active-parent');
        var current = $(this).next();
        if (current.is(':visible')) {
           li.find("ul.dropdown-menu").slideUp('fast');
           li.find("ul.dropdown-menu a").removeClass('active')
        }
        else {
           another_items.find("ul.dropdown-menu").slideUp('fast');
           current.slideDown('fast');
        }
     }
     else {
        if (li.find('a.dropdown-toggle').hasClass('active-parent')) {
        var pre = $(this).closest('ul.dropdown-menu');
        pre.find("li.dropdown").not($(this).closest('li')).find('ul.dropdown-menu').slideUp('fast');
        }
     }
     if ($(this).hasClass('active') == false) {
        $(this).parents("ul.dropdown-menu").find('a').removeClass('active');
        $(this).addClass('active')
     }
     if ($(this).attr('href') == '#') {
        e.preventDefault();
     }
  });
</script>

<script type="text/javascript">
	function DoUpdate(Url){
		$.getJSON(Url, function(data) {
	                // Now do some aggregations. data is a list of status docs for the detectors. Status can
			// either be RUNNING, IDLE, or ERROR. Last update is most recent update
	                connected = false;
			status = "NONE";
			var currentTime = new Date();
			var maxtdiff = 1000000;
			var recentTime;
			for (x = 0; x < data['status'].length; x++) {
				status = data['status'][x]['state'];
					
				var docdate = new Date(data['status'][x]['createdAt']['$date']);
				tdiff = currentTime - docdate;
				if (tdiff < maxtdiff) {
					maxtdiff = tdiff;
					recentTime = docdate;
				}
			}
			if (status == "Running"){
				document.getElementById("status").innerHTML = '<i style="color:green;" class="fa fa-check-circle"></i>';
			}
			else if ( status == "Idle" ) {
				document.getElementById("status").innerHTML = '<i style="color:yellow;" class="fa fa-exclamation-triangle"></i>';
			}
			else if ( status == "Error" ) {
				document.getElementById("status").innerHTML = '<i style="color:red;" class="fa fa-exclamation-circle"></i>';
			}
			else {
				document.getElementById("status").innerHTML = '<i style="color:red;" class="fa fa-exclamation-circle"></i>';
			}

			status_more = "<strong><div class='row emo-status-menu-entry'><div class='col-xs-2'>Detector</div>" +
					"<div class='col-xs-2'>Status</div><div class=col-xs-2>Mode</div><div class='col-xs-6'>Run name</div></div></strong>";
			for (x = 0; x < data['status'].length; x++) {
				status_more += "<div class='row emo-status-menu-entry'><div class='col-xs-2'><strong>" +
						data['status'][x]['detector'] + "</strong></div>" + "<div class='col-xs-2'>";
				if( data['status'][x]['state'] == "Running" ) {
					status_more += "<strong style='color:green;'> Running </strong></div><div class='col-xs-2'>" + data['status'][x]['mode'] +
							"</div><div class=col-xs-6>" +
							data['status'][x]['currentRun'] + "</div></div>";
				}
				else{
					status_more += "<strong style='color:red;'>" + data['status'][x]['state'] + "</strong> </div></div>";
				}
			}
			status_more+="</div>";
			document.getElementById("status_more").innerHTML = status_more;

			if( maxtdiff < 60000 ){
				document.getElementById("contact").innerHTML = '<i style="color:green;" class="fa fa-check-circle"></i>';
				document.getElementById("contact_more").innerHTML = "<div class='emo-status-menu-entry'><strong style='color:green;'>" +
					"Network connection established: </strong> Most recent status " +
					"check-in: " + Math.round(maxtdiff / 1000).toString() + " seconds ago.</div>";
			}
			else {
				document.getElementById("contact").innerHTML = '<i style="color:red;" class="fa fa-exclamation-circle"></i>';
				document.getElementById("contact_more").innerHTML = "<div class='emo-status-menu-entry'><strong style='color:red;'>" +
					"No connection to the DAQ database: </strong> Most recent status " +
					"check-in: " + Math.round(maxtdiff / 1000).toString() + " seconds ago.</div>";
				document.getElementById("status").innerHTML = '<i style="color:#AAAAAA;" class="fa fa-question-circle"></i>';
				document.getElementById("status_more").innerHTML = "<div class='emo-status-menu-entry'><strong style='color:red;'>" +
					"We can't connect: </strong> So we don't really know what the status is. Consider logging into the DAQ cluster " +
						"directly.</div>";

			}
		        if( data["issues"] == false ){
			    document.getElementById("alerts").innerHTML = '<i style="color:green;" class="fa fa-check-circle"></i>';
			    document.getElementById("alerts_more").innerHTML = "<div class='emo-status-menu-entry'><strong style='color:green;'>" +
			    		"No open alerts: </strong> You seem to be in the clear.</div>";
		            global_can_start_runs = true;
		        }
                        else{
                            document.getElementById("alerts").innerHTML = '<i style="color:red;" class="fa fa-exclamation"></i>';
		            document.getElementById("alerts_more").innerHTML = "<div class='emo-status-menu-entry'><strong sty\
le='color:red;'>" + "Open alerts! </strong> Close them on the <a href='/log?priority=-2'>log page</log></div>";
			    global_can_start_runs = false;
                        }
		});
	        
	        setTimeout(function() {
                    DoUpdate( Url );
                }, 10000 );
	}
	var UpdateUrl = "/control/get_status_update";
	$(function(){
			DoUpdate(UpdateUrl);
	});

</script>

</html>
